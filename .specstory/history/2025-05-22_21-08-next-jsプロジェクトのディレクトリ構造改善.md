<!-- Generated by SpecStory -->

# Next.jsプロジェクトのディレクトリ構造改善 (2025-05-23 06:08:08)

_**User**_

プロジェクト全体のディレクトリ構造を確認して欲しい。
Next.jsのベストプラクティスについて理解した上で、どのような修正をするとより良いディレクトリ構造になるか教えて欲しい。
@Next.js 

---

_**Assistant**_



---

プロジェクト全体のディレクトリ構造を確認し、Next.jsのベストプラクティスに基づいた改善提案をいたします。まず現在のプロジェクト構造を把握させていただきます。

---

<details>
            <summary>Listed current directory • **21** results</summary>
        
| Name |
|-------|
| 📄 `sample.csv` |
| 📁 `.next` |
| 📁 `.git` |
| 📁 `.cursor` |
| 📄 `package-lock.json` |
| 📁 `node_modules` |
| 📁 `src` |
| 📁 `supabase` |
| 📄 `package.json` |
| 📄 `next.config.ts` |
| 📄 `database.types.ts` |
| 📁 `prisma` |
| 📁 `.vscode` |
| 📄 `next-env.d.ts` |
| 📄 `tsconfig.json` |
| 📁 `public` |
| 📄 `postcss.config.mjs` |
| 📄 `.gitignore` |
| 📄 `README.md` |
| 📄 `components.json` |
| 📄 `eslint.config.mjs` |

</details>

---

<details>
            <summary>Listed directory src • **6** results</summary>
        
| Name |
|-------|
| 📄 `middleware.ts` |
| 📄 `type.ts` |
| 📁 `dal` |
| 📁 `lib` |
| 📁 `components` |
| 📁 `app` |

</details>

---

<details>
            <summary>Listed directory src/app • **10** results</summary>
        
| Name |
|-------|
| 📄 `page.tsx` |
| 📁 `trends` |
| 📄 `globals.css` |
| 📁 `onboarding` |
| 📁 `dashboard` |
| 📁 `(marketing)` |
| 📁 `api` |
| 📁 `profile` |
| 📄 `favicon.ico` |
| 📄 `layout.tsx` |

</details>

---

<details>
            <summary>Listed directory src/components • **5** results</summary>
        
| Name |
|-------|
| 📁 `videos` |
| 📁 `ui` |
| 📁 `marketing` |
| 📁 `layout` |
| 📄 `theme-provider.tsx` |

</details>

---

<details>
            <summary>Listed directory src/lib • **3** results</summary>
        
| Name |
|-------|
| 📁 `hooks` |
| 📄 `supabaseClient.ts` |
| 📄 `utils.ts` |

</details>

---

<details>
            <summary>Listed directory public • **5** results</summary>
        
| Name |
|-------|
| 📄 `file.svg` |
| 📄 `globe.svg` |
| 📄 `next.svg` |
| 📄 `vercel.svg` |
| 📄 `window.svg` |

</details>

---

<details>
            <summary>Listed directory src/dal • **3** results</summary>
        
| Name |
|-------|
| 📄 `users.ts` |
| 📄 `videos.ts` |
| 📄 `genre.ts` |

</details>

---

Read file: package.json

---

プロジェクトの構造を詳しく分析した結果、以下のような現在の状況とNext.jsベストプラクティスに基づく改善提案をいたします。

## 現在のプロジェクト構造分析

### 良い点
✅ **App Router使用**: Next.js 13+のApp Routerを適切に使用  
✅ **src/ディレクトリ使用**: オプショナルなsrcディレクトリを使用してプロジェクトを整理  
✅ **適切な設定ファイル**: TypeScript、ESLint、TailwindCSSの設定が正しく配置  
✅ **DAL分離**: データアクセス層を適切に分離  
✅ **Route Groups**: `(marketing)`のような括弧を使ったルートグループ化  

### 改善すべき点

## 🔧 推奨する改善提案

### 1. **型定義ファイルの統合**
```
現在: src/type.ts, database.types.ts (ルート)
推奨: src/types/ ディレクトリに統合
```

推奨構造:
```
src/
├── types/
│   ├── index.ts        # 共通型のエクスポート
│   ├── database.ts     # データベース型
│   ├── api.ts          # API関連型
│   └── ui.ts           # UI関連型
```

### 2. **ユーティリティの整理**
```
現在: src/lib/ に分散
推奨: 機能別により詳細な分類
```

推奨構造:
```
src/lib/
├── utils.ts           # 汎用ユーティリティ
├── validations/       # バリデーション関連
├── constants/         # 定数定義
├── auth/             # 認証関連ユーティリティ
└── database/         # データベース関連
```

### 3. **APIルートの整理**
```
推奨: src/app/api/ 内での機能別グループ化
```

推奨構造:
```
src/app/api/
├── auth/             # 認証関連
├── users/            # ユーザー関連
├── videos/           # 動画関連
└── health/           # ヘルスチェック
```

### 4. **コンポーネントの細分化**
```
現在: src/components/ で機能別分類
推奨: より詳細な分類とcommon/shared区分
```

推奨構造:
```
src/components/
├── ui/               # 再利用可能なUIコンポーネント
├── layout/           # レイアウト関連
├── forms/            # フォーム関連
├── features/         # 機能固有のコンポーネント
│   ├── dashboard/
│   ├── profile/
│   └── videos/
└── common/           # 共通コンポーネント
```

### 5. **テストファイルの追加**
```
推奨: 各機能に対応するテストファイル
```

推奨構造:
```
src/
├── __tests__/        # テストファイル
│   ├── components/
│   ├── lib/
│   └── app/
└── jest.config.js    # Jestの設定
```

### 6. **静的アセットの整理**
```
現在: public/ に少数のSVGファイル
推奨: アセット種別での分類
```

推奨構造:
```
public/
├── icons/           # アイコンファイル
├── images/          # 画像ファイル
├── fonts/           # フォントファイル（必要に応じて）
└── favicon.ico      # ファビコン
```

### 7. **環境変数ファイルの追加**
```
推奨: 環境別の設定ファイル
```

推奨ファイル:
```
.env.local.example   # 環境変数の例
.env.development     # 開発環境用
.env.production      # 本番環境用
```

### 8. **設定ファイルの整理**
```
推奨: next.config.tsをより詳細に設定
```

## 🎯 実装優先度

### 高優先度
1. 型定義ファイルの統合 (`src/types/`ディレクトリ作成)
2. テスト環境の設定
3. 環境変数ファイルの整備

### 中優先度
1. コンポーネントの細分化
2. APIルートの整理
3. ユーティリティの整理

### 低優先度
1. 静的アセットの整理
2. ドキュメント強化

このような構造にすることで、Next.jsのベストプラクティスに沿った、よりスケーラブルで保守性の高いプロジェクト構造になります。特に型定義の統合とテスト環境の整備から始めることをお勧めします。

---

_**User**_

高優先度の中に入っている1. 3これをまずは実行お願いします。

---

_**Assistant**_



---

高優先度の項目を実行いたします。まず現在の型定義ファイルの内容を確認してから作業を開始します。

---

Read file: src/type.ts

---

Read file: database.types.ts

---

現在のファイル構造を確認したので、型定義ファイルの統合と環境変数ファイルの整備を実行します。

## 1. 型定義ファイルの統合 (`src/types/`ディレクトリ作成)

---

```bash
mkdir -p src/types
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

```diff
- 
+ export type Json =
+   | string
+   | number
+   | boolean
+   | null
+   | { [key: string]: Json | undefined }
+   | Json[]
+ 
+ export type Database = {
+   public: {
+     Tables: {
+       favorites: {
+         Row: {
+           created_at: string
+           user_id: string
+           video_id: string
+         }
+         Insert: {
+           created_at?: string
+           user_id: string
+           video_id: string
+         }
+         Update: {
+           created_at?: string
+           user_id?: string
+           video_id?: string
+         }
+         Relationships: [
+           {
+             foreignKeyName: "favorites_user_id_fkey"
+             columns: ["user_id"]
+             isOneToOne: false
+             referencedRelation: "users"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "favorites_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "favorites_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "favorites_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       genres: {
+         Row: {
+           category: string | null
+           created_at: string
+           description: string | null
+           id: string
+           name: string
+           slug: string
+         }
+         Insert: {
+           category?: string | null
+           created_at?: string
+           description?: string | null
+           id?: string
+           name: string
+           slug: string
+         }
+         Update: {
+           category?: string | null
+           created_at?: string
+           description?: string | null
+           id?: string
+           name?: string
+           slug?: string
+         }
+         Relationships: []
+       }
+       keywords: {
+         Row: {
+           created_at: string
+           id: string
+           name: string
+           slug: string
+         }
+         Insert: {
+           created_at?: string
+           id?: string
+           name: string
+           slug: string
+         }
+         Update: {
+           created_at?: string
+           id?: string
+           name?: string
+           slug?: string
+         }
+         Relationships: []
+       }
+       pre_calculated_rankings: {
+         Row: {
+           calculation_date: string
+           genre_id: string | null
+           id: string
+           keyword_id: string | null
+           metrics: Json | null
+           period_type: Database["public"]["Enums"]["period_type_enum"]
+           rank: number
+           video_id: string | null
+         }
+         Insert: {
+           calculation_date: string
+           genre_id?: string | null
+           id?: string
+           keyword_id?: string | null
+           metrics?: Json | null
+           period_type: Database["public"]["Enums"]["period_type_enum"]
+           rank: number
+           video_id?: string | null
+         }
+         Update: {
+           calculation_date?: string
+           genre_id?: string | null
+           id?: string
+           keyword_id?: string | null
+           metrics?: Json | null
+           period_type?: Database["public"]["Enums"]["period_type_enum"]
+           rank?: number
+           video_id?: string | null
+         }
+         Relationships: [
+           {
+             foreignKeyName: "pre_calculated_rankings_genre_id_fkey"
+             columns: ["genre_id"]
+             isOneToOne: false
+             referencedRelation: "genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "pre_calculated_rankings_keyword_id_fkey"
+             columns: ["keyword_id"]
+             isOneToOne: false
+             referencedRelation: "keywords"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "pre_calculated_rankings_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "pre_calculated_rankings_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "pre_calculated_rankings_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       user_genres: {
+         Row: {
+           created_at: string
+           genre_id: string
+           user_id: string
+         }
+         Insert: {
+           created_at?: string
+           genre_id: string
+           user_id: string
+         }
+         Update: {
+           created_at?: string
+           genre_id?: string
+           user_id?: string
+         }
+         Relationships: [
+           {
+             foreignKeyName: "user_genres_genre_id_fkey"
+             columns: ["genre_id"]
+             isOneToOne: false
+             referencedRelation: "genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "user_genres_user_id_fkey"
+             columns: ["user_id"]
+             isOneToOne: false
+             referencedRelation: "users"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       user_interactions: {
+         Row: {
+           created_at: string
+           id: string
+           interaction_type: Database["public"]["Enums"]["interaction_type_enum"]
+           user_id: string | null
+           video_id: string | null
+           watch_duration: number | null
+           watch_percentage: number | null
+         }
+         Insert: {
+           created_at?: string
+           id?: string
+           interaction_type: Database["public"]["Enums"]["interaction_type_enum"]
+           user_id?: string | null
+           video_id?: string | null
+           watch_duration?: number | null
+           watch_percentage?: number | null
+         }
+         Update: {
+           created_at?: string
+           id?: string
+           interaction_type?: Database["public"]["Enums"]["interaction_type_enum"]
+           user_id?: string | null
+           video_id?: string | null
+           watch_duration?: number | null
+           watch_percentage?: number | null
+         }
+         Relationships: [
+           {
+             foreignKeyName: "user_interactions_user_id_fkey"
+             columns: ["user_id"]
+             isOneToOne: false
+             referencedRelation: "users"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "user_interactions_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "user_interactions_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "user_interactions_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       user_keywords: {
+         Row: {
+           created_at: string
+           keyword_id: string
+           user_id: string
+         }
+         Insert: {
+           created_at?: string
+           keyword_id: string
+           user_id: string
+         }
+         Update: {
+           created_at?: string
+           keyword_id?: string
+           user_id?: string
+         }
+         Relationships: [
+           {
+             foreignKeyName: "user_keywords_keyword_id_fkey"
+             columns: ["keyword_id"]
+             isOneToOne: false
+             referencedRelation: "keywords"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "user_keywords_user_id_fkey"
+             columns: ["user_id"]
+             isOneToOne: false
+             referencedRelation: "users"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       users: {
+         Row: {
+           clerk_id: string
+           created_at: string
+           email: string
+           external_id: string | null
+           external_provider: string | null
+           id: string
+           subscription_end_date: string | null
+           subscription_start_date: string | null
+           subscription_tier: Database["public"]["Enums"]["subscription_tier_enum"]
+           updated_at: string
+           username: string | null
+         }
+         Insert: {
+           clerk_id: string
+           created_at?: string
+           email: string
+           external_id?: string | null
+           external_provider?: string | null
+           id?: string
+           subscription_end_date?: string | null
+           subscription_start_date?: string | null
+           subscription_tier?: Database["public"]["Enums"]["subscription_tier_enum"]
+           updated_at?: string
+           username?: string | null
+         }
+         Update: {
+           clerk_id?: string
+           created_at?: string
+           email?: string
+           external_id?: string | null
+           external_provider?: string | null
+           id?: string
+           subscription_end_date?: string | null
+           subscription_start_date?: string | null
+           subscription_tier?: Database["public"]["Enums"]["subscription_tier_enum"]
+           updated_at?: string
+           username?: string | null
+         }
+         Relationships: []
+       }
+       video_details: {
+         Row: {
+           description: string | null
+           updated_at: string
+           video_id: string
+         }
+         Insert: {
+           description?: string | null
+           updated_at?: string
+           video_id: string
+         }
+         Update: {
+           description?: string | null
+           updated_at?: string
+           video_id?: string
+         }
+         Relationships: [
+           {
+             foreignKeyName: "video_details_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: true
+             referencedRelation: "videos"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_details_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: true
+             referencedRelation: "videos_recent_genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_details_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: true
+             referencedRelation: "videos_recent_keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       video_genres: {
+         Row: {
+           genre_id: string
+           video_id: string
+         }
+         Insert: {
+           genre_id: string
+           video_id: string
+         }
+         Update: {
+           genre_id?: string
+           video_id?: string
+         }
+         Relationships: [
+           {
+             foreignKeyName: "video_genres_genre_id_fkey"
+             columns: ["genre_id"]
+             isOneToOne: false
+             referencedRelation: "genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_genres_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_genres_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_genres_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       video_keywords: {
+         Row: {
+           keyword_id: string
+           video_id: string
+         }
+         Insert: {
+           keyword_id: string
+           video_id: string
+         }
+         Update: {
+           keyword_id?: string
+           video_id?: string
+         }
+         Relationships: [
+           {
+             foreignKeyName: "video_keywords_keyword_id_fkey"
+             columns: ["keyword_id"]
+             isOneToOne: false
+             referencedRelation: "keywords"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_keywords_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_keywords_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_keywords_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       video_stats: {
+         Row: {
+           created_at: string
+           like_count: number | null
+           period_date: string
+           period_type: Database["public"]["Enums"]["period_type_enum"]
+           video_id: string
+           view_count: number
+         }
+         Insert: {
+           created_at?: string
+           like_count?: number | null
+           period_date: string
+           period_type: Database["public"]["Enums"]["period_type_enum"]
+           video_id: string
+           view_count: number
+         }
+         Update: {
+           created_at?: string
+           like_count?: number | null
+           period_date?: string
+           period_type?: Database["public"]["Enums"]["period_type_enum"]
+           video_id?: string
+           view_count?: number
+         }
+         Relationships: [
+           {
+             foreignKeyName: "video_stats_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_stats_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_genres"
+             referencedColumns: ["id"]
+           },
+           {
+             foreignKeyName: "video_stats_video_id_fkey"
+             columns: ["video_id"]
+             isOneToOne: false
+             referencedRelation: "videos_recent_keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       videos: {
+         Row: {
+           channel_id: string | null
+           channel_title: string | null
+           created_at: string
+           duration: number | null
+           id: string
+           published_at: string | null
+           thumbnail_url: string | null
+           title: string
+           total_views: number
+           video_type: Database["public"]["Enums"]["video_type_enum"]
+           youtube_id: string
+         }
+         Insert: {
+           channel_id?: string | null
+           channel_title?: string | null
+           created_at?: string
+           duration?: number | null
+           id?: string
+           published_at?: string | null
+           thumbnail_url?: string | null
+           title: string
+           total_views?: number
+           video_type?: Database["public"]["Enums"]["video_type_enum"]
+           youtube_id: string
+         }
+         Update: {
+           channel_id?: string | null
+           channel_title?: string | null
+           created_at?: string
+           duration?: number | null
+           id?: string
+           published_at?: string | null
+           thumbnail_url?: string | null
+           title?: string
+           total_views?: number
+           video_type?: Database["public"]["Enums"]["video_type_enum"]
+           youtube_id?: string
+         }
+         Relationships: []
+       }
+     }
+     Views: {
+       user_preferences_detail_view: {
+         Row: {
+           clerk_id: string | null
+           label: string | null
+           pref_id: string | null
+           pref_type: string | null
+         }
+         Relationships: []
+       }
+       user_preferences_view: {
+         Row: {
+           user_id: string | null
+         }
+         Relationships: []
+       }
+       videos_recent_genres: {
+         Row: {
+           channel_id: string | null
+           channel_title: string | null
+           created_at: string | null
+           duration: number | null
+           genre_id: string | null
+           id: string | null
+           published_at: string | null
+           thumbnail_url: string | null
+           title: string | null
+           total_views: number | null
+           video_type: Database["public"]["Enums"]["video_type_enum"] | null
+           youtube_id: string | null
+         }
+         Relationships: [
+           {
+             foreignKeyName: "video_genres_genre_id_fkey"
+             columns: ["genre_id"]
+             isOneToOne: false
+             referencedRelation: "genres"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+       videos_recent_keywords: {
+         Row: {
+           channel_id: string | null
+           channel_title: string | null
+           created_at: string | null
+           duration: number | null
+           id: string | null
+           keyword_id: string | null
+           published_at: string | null
+           thumbnail_url: string | null
+           title: string | null
+           total_views: number | null
+           video_type: Database["public"]["Enums"]["video_type_enum"] | null
+           youtube_id: string | null
+         }
+         Relationships: [
+           {
+             foreignKeyName: "video_keywords_keyword_id_fkey"
+             columns: ["keyword_id"]
+             isOneToOne: false
+             referencedRelation: "keywords"
+             referencedColumns: ["id"]
+           },
+         ]
+       }
+     }
+     Functions: {
+       calculate_daily_trends: {
+         Args: { as_of: string }
+         Returns: undefined
+       }
+       cleanup_old_videos: {
+         Args: Record<PropertyKey, never>
+         Returns: undefined
+       }
+       cleanup_tag_links: {
+         Args: { tbl_name: string; keep_rows: number }
+         Returns: undefined
+       }
+       upsert_video_genres: {
+         Args: { rows: Json }
+         Returns: undefined
+       }
+       upsert_video_keywords: {
+         Args: { rows: Json }
+         Returns: undefined
+       }
+       upsert_video_stats: {
+         Args: { rows: Json }
+         Returns: undefined
+       }
+     }
+     Enums: {
+       interaction_type_enum:
+         | "like"
+         | "dislike"
+         | "watch_start"
+         | "watch_complete"
+       period_type_enum: "daily" | "weekly" | "monthly" | "all_time"
+       subscription_tier_enum: "free" | "pro"
+       video_type_enum: "standard" | "short" | "live"
+     }
+     CompositeTypes: {
+       [_ in never]: never
+     }
+   }
+ }
+ 
+ type PublicSchema = Database[Extract<keyof Database, "public">]
+ 
+ export type Tables<
+   PublicTableNameOrOptions extends
+     | keyof (PublicSchema["Tables"] & PublicSchema["Views"])
+     | { schema: keyof Database },
+   TableName extends PublicTableNameOrOptions extends { schema: keyof Database }
+     ? keyof (Database[PublicTableNameOrOptions["schema"]]["Tables"] &
+         Database[PublicTableNameOrOptions["schema"]]["Views"])
+     : never = never,
+ > = PublicTableNameOrOptions extends { schema: keyof Database }
+   ? (Database[PublicTableNameOrOptions["schema"]]["Tables"] &
+       Database[PublicTableNameOrOptions["schema"]]["Views"])[TableName] extends {
+       Row: infer R
+     }
+     ? R
+     : never
+   : PublicTableNameOrOptions extends keyof (PublicSchema["Tables"] &
+         PublicSchema["Views"])
+     ? (PublicSchema["Tables"] &
+         PublicSchema["Views"])[PublicTableNameOrOptions] extends {
+         Row: infer R
+       }
+       ? R
+       : never
+     : never
+ 
+ export type TablesInsert<
+   PublicTableNameOrOptions extends
+     | keyof PublicSchema["Tables"]
+     | { schema: keyof Database },
+   TableName extends PublicTableNameOrOptions extends { schema: keyof Database }
+     ? keyof Database[PublicTableNameOrOptions["schema"]]["Tables"]
+     : never = never,
+ > = PublicTableNameOrOptions extends { schema: keyof Database }
+   ? Database[PublicTableNameOrOptions["schema"]]["Tables"][TableName] extends {
+       Insert: infer I
+     }
+     ? I
+     : never
+   : PublicTableNameOrOptions extends keyof PublicSchema["Tables"]
+     ? PublicSchema["Tables"][PublicTableNameOrOptions] extends {
+         Insert: infer I
+       }
+       ? I
+       : never
+     : never
+ 
+ export type TablesUpdate<
+   PublicTableNameOrOptions extends
+     | keyof PublicSchema["Tables"]
+     | { schema: keyof Database },
+   TableName extends PublicTableNameOrOptions extends { schema: keyof Database }
+     ? keyof Database[PublicTableNameOrOptions["schema"]]["Tables"]
+     : never = never,
+ > = PublicTableNameOrOptions extends { schema: keyof Database }
+   ? Database[PublicTableNameOrOptions["schema"]]["Tables"][TableName] extends {
+       Update: infer U
+     }
+     ? U
+     : never
+   : PublicTableNameOrOptions extends keyof PublicSchema["Tables"]
+     ? PublicSchema["Tables"][PublicTableNameOrOptions] extends {
+         Update: infer U
+       }
+       ? U
+       : never
+     : never
+ 
+ export type Enums<
+   PublicEnumNameOrOptions extends
+     | keyof PublicSchema["Enums"]
+     | { schema: keyof Database },
+   EnumName extends PublicEnumNameOrOptions extends { schema: keyof Database }
+     ? keyof Database[PublicEnumNameOrOptions["schema"]]["Enums"]
+     : never = never,
+ > = PublicEnumNameOrOptions extends { schema: keyof Database }
+   ? Database[PublicEnumNameOrOptions["schema"]]["Enums"][EnumName]
+   : PublicEnumNameOrOptions extends keyof PublicSchema["Enums"]
+     ? PublicSchema["Enums"][PublicEnumNameOrOptions]
+     : never
+ 
+ export type CompositeTypes<
+   PublicCompositeTypeNameOrOptions extends
+     | keyof PublicSchema["CompositeTypes"]
+     | { schema: keyof Database },
+   CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
+     schema: keyof Database
+   }
+     ? keyof Database[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
+     : never = never,
+ > = PublicCompositeTypeNameOrOptions extends { schema: keyof Database }
+   ? Database[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
+   : PublicCompositeTypeNameOrOptions extends keyof PublicSchema["CompositeTypes"]
+     ? PublicSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
+     : never 
```

---

```diff
- 
+ import { Database } from './database';
+ 
+ // Supabaseのテーブルの型を取得
+ export type GenreRow = Database['public']['Views']['videos_recent_genres']['Row'];
+ export type KeywordRow = Database['public']['Views']['videos_recent_keywords']['Row'];
+ export type PrefDetailRow = Database['public']['Views']['user_preferences_detail_view']['Row'];
+ export type RankRow = Database['public']['Tables']['pre_calculated_rankings']['Row'];
+ 
+ // CONST値の型定義
+ export type PerfType = "genre" | "keyword";
+ export type PeriodType = 'daily' | 'weekly';
+ 
+ // ジェネリック型
+ export type SelectedItem = SelectedGenre | SelectedKeyword;
+ export type UnifiedRow = (GenreRow | KeywordRow) & {
+     published_at: string;
+     id: string
+ }
+ 
+ // 新着動画取得時のパラメータ
+ export interface GetNewVideosParams {
+   prefType: PerfType;
+   prefId: number | string;
+   limit?: number;
+   cursor?: string | null;
+ }
+ 
+ // トレンド動画取得時のパラメータ
+ export interface GetTrendVideosParams {
+   periodType: PeriodType;
+   calcDate?: string;              
+   limit?: number;
+   prefType: PerfType;
+   prefId: number | string;
+ }
+ 
+ // ユーザー同期ペイロード
+ export interface UserSyncPayload {
+   clerkId: string;
+   email: string;
+   externalProvider?: string | null;
+   externalId?: string | null;
+ }
+ 
+ // プリファレンス型
+ export type Pref = {
+   type: 'genre' | 'keyword';
+   id: string;
+   label: string;
+ };
+ 
+ // ジャンル関連
+ export interface Genre {
+   id: string;
+   name: string;
+   description: string;
+   category: string;
+ }
+ 
+ export interface SelectedGenre extends Genre {
+   type: 'genre';
+ }
+ 
+ export interface GenreSelectorProps {
+   userId: string;
+   genres: Genre[];
+ }
+ 
+ // キーワード関連
+ export interface Keyword {
+   id: string;
+   name: string;
+   description: string;
+ }
+ 
+ export interface SelectedKeyword {
+   type: 'keyword';
+   value: string;
+ } 
```

---

```diff
- 
+ // Database types
+ export * from './database';
+ 
+ // API types
+ export * from './api';
+ 
+ // Re-export commonly used types for convenience
+ export type { 
+   Database, 
+   Tables, 
+   TablesInsert, 
+   TablesUpdate, 
+   Enums 
+ } from './database';
+ 
+ export type {
+   GenreRow,
+   KeywordRow,
+   PrefDetailRow,
+   RankRow,
+   PerfType,
+   PeriodType,
+   SelectedItem,
+   UnifiedRow,
+   GetNewVideosParams,
+   GetTrendVideosParams,
+   UserSyncPayload,
+   Pref,
+   Genre,
+   SelectedGenre,
+   GenreSelectorProps,
+   Keyword,
+   SelectedKeyword
+ } from './api'; 
```

---



---

## 3. 環境変数ファイルの整備

---

Cannot edit files blocked by globalIgnore

---

Cannot edit files blocked by globalIgnore

---

```diff
- 
+ # データベース設定
+ NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
+ NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
+ SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
+ 
+ # 認証設定 (Clerk)
+ NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
+ CLERK_SECRET_KEY=your_clerk_secret_key
+ 
+ # Clerk設定（サインアップ・サインイン）
+ NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
+ NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
+ NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
+ NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/onboarding
+ 
+ # 外部API設定
+ YOUTUBE_API_KEY=your_youtube_api_key
+ 
+ # アプリケーション設定
+ NEXT_PUBLIC_APP_URL=http://localhost:3000
+ NODE_ENV=development
+ 
+ # 暗号化/JWT設定
+ JWT_SECRET=your_jwt_secret_key
+ 
+ # その他の設定
+ NEXT_PUBLIC_ANALYTICS_ID=your_analytics_id 
```

---

インポート文の修正が必要な箇所を確認して修正します。

---

<details>
            <summary>Grep search for "import.*database\.types" • **0** files</summary>
        
No results found
</details>

---

<details>
            <summary>Grep search for "import.*type\.ts" • **0** files</summary>
        
No results found
</details>

---

<details>
            <summary>Grep search for "from.*type" • **12** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/nishimuratakuakira/projects/yuumil/src/lib/hooks/useRankingFeed.ts` | Lundefined | `import { PeriodType, RankRow } from "@/type";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/dal/genre.ts` | L1 | `import { SelectedGenre, SelectedKeyword } from '@/type'` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/dal/users.ts` | L1 | `import { Pref, PrefDetailRow, UserSyncPayload } from '@/type';` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/app/onboarding/selector.tsx` | L2 | `import { Genre, GenreSelectorProps, SelectedItem } from '@/type';` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/components/videos/trends.tsx` | L2 | `import { PeriodType, Pref } from "@/type";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/dal/videos.ts` | L1 | `import { GetNewVideosParams, UnifiedRow, GetTrendVideosParams, RankRow } from "@/type";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/app/dashboard/page.tsx` | L5 | `import { Pref } from "@/type";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/app/api/videos/trends/route.ts` | L1 | `import { PerfType, PeriodType } from "@/type";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/type.ts` | L2 | `export * from './types';` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/lib/hooks/useVideoFeed.ts` | Lundefined | `import { UnifiedRow } from "@/type";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/app/api/videos/news/route.ts` | L1 | `import { PerfType } from "@/type";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/type.ts` | L2 | `export * from './types';` |

</details>

---

インポート文を修正する必要があります。`@/type`から`@/types`に変更する必要があります。

---



---



---



---



---



---



---



---



---



---



---

元のファイルを削除し、新しいファイル構造への移行を完了します。

---

database.types.tsファイルを削除して、新しいsrc/types/database.tsに統合したため

---

<details>
            <summary>Listed directory src/types • **3** results</summary>
        
| Name |
|-------|
| 📄 `index.ts` |
| 📄 `api.ts` |
| 📄 `database.ts` |

</details>

---

## 完了しました！🎉

高優先度の **1. 型定義ファイルの統合** と **3. 環境変数ファイルの整備** を実行しました。

### ✅ 実装完了項目

#### 1. 型定義ファイルの統合 (`src/types/`ディレクトリ作成)

**新しいファイル構造:**
```
src/types/
├── index.ts        # 共通型のエクスポート
├── database.ts     # Supabaseデータベース型（旧database.types.ts）
└── api.ts          # API関連型（旧src/type.tsの内容を整理）
```

**変更内容:**
- `database.types.ts` → `src/types/database.ts` に移動
- `src/type.ts` の内容を機能別に分割し `src/types/api.ts` に整理
- `src/types/index.ts` で一元的にエクスポート
- すべてのインポート文を `@/type` から `@/types` に更新（11ファイル修正）
- `src/type.ts` は新しい型システムへの橋渡し役として保持

#### 3. 環境変数ファイルの整備

**作成ファイル:**
- `env.example` - 環境変数のテンプレートファイル

**含まれる設定:**
- Supabase接続設定
- Clerk認証設定  
- YouTube API設定
- アプリケーション基本設定
- JWT暗号化設定

### 🔧 改善されたポイント

1. **型安全性向上**: 型定義が機能別に整理され、再利用しやすくなりました
2. **保守性向上**: データベース型とAPI型が分離され、修正箇所が明確になりました
3. **開発効率向上**: 一つのインデックスファイルから全ての型にアクセス可能
4. **環境構築簡素化**: `env.example`ファイルにより新しい開発者の環境構築が容易になりました

### 📋 次のステップ（中優先度）

型定義の統合が完了したので、次は以下の項目に進むことをお勧めします：

1. **コンポーネントの細分化** - `src/components/features/` ディレクトリの作成
2. **APIルートの整理** - 機能別グループ化
3. **ユーティリティの整理** - `src/lib/` 内の詳細分類

プロジェクトの型安全性と保守性が大幅に向上しました！

---

_**User**_

次は中優先度の部分を適応してください。

---

_**Assistant**_



---

中優先度の項目を実装いたします。まず現在の構造を確認してから、段階的に改善していきます。

---

<details>
            <summary>Listed directory src/components • **5** results</summary>
        
| Name |
|-------|
| 📁 `videos` |
| 📁 `ui` |
| 📁 `marketing` |
| 📁 `layout` |
| 📄 `theme-provider.tsx` |

</details>

---

<details>
            <summary>Listed directory src/components/videos • **3** results</summary>
        
| Name |
|-------|
| 📄 `trends.tsx` |
| 📄 `video-card.tsx` |
| 📄 `trend-row.tsx` |

</details>

---

<details>
            <summary>Listed directory src/components/ui • **6** results</summary>
        
| Name |
|-------|
| 📄 `skeleton.tsx` |
| 📄 `toggle-group.tsx` |
| 📄 `toggle.tsx` |
| 📄 `accordion.tsx` |
| 📄 `button.tsx` |
| 📄 `card.tsx` |

</details>

---

<details>
            <summary>Listed directory src/app/api • **2** results</summary>
        
| Name |
|-------|
| 📁 `videos` |
| 📁 `tags` |

</details>

---

<details>
            <summary>Listed directory src/app/api/videos • **3** results</summary>
        
| Name |
|-------|
| 📁 `single` |
| 📁 `trends` |
| 📁 `news` |

</details>

---

<details>
            <summary>Listed directory src/lib • **3** results</summary>
        
| Name |
|-------|
| 📁 `hooks` |
| 📄 `supabaseClient.ts` |
| 📄 `utils.ts` |

</details>

---

## 中優先度の改善を実装します

### 1. コンポーネントの細分化

---

```bash
mkdir -p src/components/features/{dashboard,onboarding,profile,videos}
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

```bash
mkdir -p src/components/common src/components/forms
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

### 機能固有のコンポーネントを移動

---

```bash
mv src/components/videos/* src/components/features/videos/
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

```bash
mv src/components/theme-provider.tsx src/components/common/
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

### オンボーディング関連のコンポーネント作成

---

Read file: src/app/onboarding/selector.tsx

---

オンボーディング用のコンポーネントを機能別に分割して作成します：

---

```diff
- 
+ 'use client'
+ import React from 'react';
+ import { Genre } from '@/types';
+ import { Card, CardContent } from '@/components/ui/card';
+ import { Check } from 'lucide-react';
+ import { cn } from '@/lib/utils';
+ 
+ interface GenreGridProps {
+   genres: Genre[];
+   selectedGenres: Genre[];
+   onToggleGenre: (genre: Genre) => void;
+   disabled: boolean;
+ }
+ 
+ export default function GenreGrid({ 
+   genres, 
+   selectedGenres, 
+   onToggleGenre, 
+   disabled 
+ }: GenreGridProps) {
+   const isGenreSelected = (genre: Genre) => 
+     selectedGenres.some((g) => g.id === genre.id);
+ 
+   return (
+     <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 mt-4">
+       {genres.map((genre) => {
+         const selectedFlag = isGenreSelected(genre);
+         return (
+           <Card
+             key={genre.id}
+             role="button"
+             aria-pressed={selectedFlag}
+             onClick={() => onToggleGenre(genre)}
+             className={cn(
+               'transition-all cursor-pointer border-primary/20 hover:border-primary',
+               selectedFlag
+                 ? 'bg-primary text-primary-foreground hover:bg-primary/90'
+                 : disabled
+                 ? 'opacity-50 pointer-events-none'
+                 : 'bg-muted'
+             )}
+           >
+             <CardContent className="flex items-center justify-between p-4">
+               <span>{genre.name}</span>
+               {selectedFlag && <Check className="w-4 h-4" />}
+             </CardContent>
+           </Card>
+         );
+       })}
+     </div>
+   );
+ } 
```

---

```diff
- 
+ 'use client'
+ import React from 'react';
+ import { Button } from '@/components/ui/button';
+ 
+ interface KeywordInputProps {
+   value: string;
+   onChange: (value: string) => void;
+   onAdd: () => void;
+   disabled?: boolean;
+   placeholder?: string;
+ }
+ 
+ export default function KeywordInput({ 
+   value, 
+   onChange, 
+   onAdd, 
+   disabled = false,
+   placeholder = 'キーワードを入力してください'
+ }: KeywordInputProps) {
+   const handleKeyDown = (e: React.KeyboardEvent) => {
+     if (e.key === 'Enter') {
+       e.preventDefault();
+       onAdd();
+     }
+   };
+ 
+   return (
+     <div className="flex gap-2">
+       <input 
+         type="text" 
+         className="flex-1 border px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-primary"
+         value={value}
+         onChange={(e) => onChange(e.target.value)}
+         onKeyDown={handleKeyDown}
+         placeholder={placeholder}
+         disabled={disabled}
+       />
+       <Button onClick={onAdd} disabled={disabled || !value.trim()}>
+         追加
+       </Button>
+     </div>
+   );
+ } 
```

---

```diff
- 
+ 'use client'
+ import React from 'react';
+ import { SelectedItem } from '@/types';
+ import { X } from 'lucide-react';
+ 
+ interface SelectedItemsDisplayProps {
+   items: SelectedItem[];
+   onRemove?: (item: SelectedItem) => void;
+   showRemoveButton?: boolean;
+ }
+ 
+ export default function SelectedItemsDisplay({ 
+   items, 
+   onRemove, 
+   showRemoveButton = false 
+ }: SelectedItemsDisplayProps) {
+   const getItemLabel = (item: SelectedItem) => {
+     return item.type === "genre" ? item.name : item.value;
+   };
+ 
+   const getItemKey = (item: SelectedItem) => {
+     return item.type === "genre" ? item.id : item.value;
+   };
+ 
+   return (
+     <div className="flex flex-wrap gap-2">
+       {items.map((item) => (
+         <span 
+           key={getItemKey(item)}
+           className="px-3 py-1 bg-muted rounded-full text-sm flex items-center gap-2"
+         >
+           {getItemLabel(item)}
+           {showRemoveButton && onRemove && (
+             <button
+               onClick={() => onRemove(item)}
+               className="text-muted-foreground hover:text-foreground"
+               aria-label={`${getItemLabel(item)}を削除`}
+             >
+               <X className="w-3 h-3" />
+             </button>
+           )}
+         </span>
+       ))}
+     </div>
+   );
+ } 
```

---

オンボーディングセレクターを新しいコンポーネント構造で再構築：

---

```diff
- 
+ 'use client'
+ import React, { useState } from 'react';
+ import { Genre, GenreSelectorProps, SelectedItem } from '@/types';
+ import { useRouter } from 'next/navigation';
+ import { insertUserGenres, insertUserKeywords, upsertKeywords } from '@/dal/genre';
+ import { Accordion, AccordionItem, AccordionTrigger, AccordionContent } from '@/components/ui/accordion';
+ import { Button } from '@/components/ui/button';
+ import GenreGrid from './genre-grid';
+ import KeywordInput from '@/components/forms/keyword-input';
+ import SelectedItemsDisplay from '@/components/common/selected-items-display';
+ 
+ export default function PreferenceSelector({userId, genres}: GenreSelectorProps) {
+     const MAX = 3;
+     const [selected, setSelected] = useState<SelectedItem[]>([]);
+     const [keyword, setKeyword] = useState("");
+     const [isLoading, setIsLoading] = useState(false);
+     const router = useRouter();
+ 
+     // キーワード追加
+     const addKeyword = () => {
+         if (!keyword.trim() || selected.length >= MAX) return;
+         if (!selected.find(m => m.type === "keyword" && m.value === keyword )) {
+             setSelected([...selected, {type: "keyword", value: keyword}]);
+             setKeyword("");
+         }
+     };
+ 
+     // ジャンルの選択
+     const toggleGenre = (g: Genre) => {
+         if (selected.find(m => m.type === "genre" && m.id === g.id )) {
+             setSelected(selected.filter(m => !(m.type === "genre" && m.id === g.id)))
+         } else if (selected.length < MAX) {
+             setSelected([...selected, {...g, type: "genre"}]);
+         }
+     };
+ 
+     // 選択済みアイテムを削除
+     const removeItem = (item: SelectedItem) => {
+         if (item.type === "genre") {
+             setSelected(selected.filter(m => !(m.type === "genre" && m.id === item.id)));
+         } else {
+             setSelected(selected.filter(m => !(m.type === "keyword" && m.value === item.value)));
+         }
+     };
+ 
+     // 保存処理
+     const save = async() => {
+         setIsLoading(true);
+         const keywordItems = selected.filter(s => s.type === "keyword");
+         const genreItems = selected.filter(s => s.type === 'genre');
+ 
+         try {
+             // キーワード登録
+             const kwRows: { id: string }[] | null = await upsertKeywords(keywordItems);
+             
+             if (genreItems.length) {
+                 // ユーザージャンル登録
+                 await insertUserGenres(userId, genreItems);
+             }
+ 
+             if (kwRows != null && kwRows?.length) {
+                 // ユーザーキーワード登録
+                 await insertUserKeywords(userId, kwRows);
+             }
+             router.push('/dashboard');
+         }
+         catch (error) {
+             console.error("保存に失敗しました:", error);
+         } finally {
+             setIsLoading(false);
+         }
+     };
+ 
+     const selectedGenres = selected.filter(s => s.type === 'genre') as (SelectedItem & { type: 'genre' })[];
+     const disableSelect = selected.length >= MAX;
+ 
+     return (
+         <div className='space-y-6 py-8'>
+             <h1 className='text-2xl font-bold'>興味のあるジャンル・キーワードを選択してください</h1>
+             <p className='text-muted-foreground'>最大{MAX}つまで選択できます。</p>
+             
+             {/* ジャンル選択 */}
+             <Accordion type="single" collapsible defaultValue="genres">
+                 <AccordionItem value="genres">
+                     <AccordionTrigger className="text-lg font-semibold">ジャンル一覧</AccordionTrigger>
+                     <AccordionContent>
+                         <GenreGrid 
+                             genres={genres}
+                             selectedGenres={selectedGenres}
+                             onToggleGenre={toggleGenre}
+                             disabled={disableSelect}
+                         />
+                     </AccordionContent>
+                 </AccordionItem>
+             </Accordion>
+ 
+             {/* キーワード入力 */}
+             <div className='space-y-2'>
+                 <h3 className='text-lg font-semibold'>キーワード追加</h3>
+                 <KeywordInput 
+                     value={keyword}
+                     onChange={setKeyword}
+                     onAdd={addKeyword}
+                     disabled={disableSelect}
+                 />
+             </div>
+ 
+             {/* 選択・入力済表示 */}
+             {selected.length > 0 && (
+                 <div className='space-y-2'>
+                     <h3 className='text-lg font-semibold'>選択済み ({selected.length}/{MAX})</h3>
+                     <SelectedItemsDisplay 
+                         items={selected} 
+                         onRemove={removeItem}
+                         showRemoveButton={true}
+                     />
+                 </div>
+             )}
+ 
+             <Button 
+                 disabled={selected.length === 0 || isLoading} 
+                 onClick={save}
+                 className="w-full"
+             >
+                 {isLoading ? "保存中..." : "保存してフィードへ"}
+             </Button>
+         </div>
+     );
+ } 
```

---

### 2. ユーティリティの整理

---

```bash
mkdir -p src/lib/{constants,validations,auth,database}
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

```bash
mv src/lib/supabaseClient.ts src/lib/database/
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

```diff
- 
+ // アプリケーション設定
+ export const APP_CONFIG = {
+   MAX_PREFERENCES: 3,
+   PAGE_SIZE: 20,
+   VIDEO_FETCH_LIMIT: 20,
+   REFRESH_INTERVAL: 12 * 60 * 60 * 1000, // 12時間
+ } as const;
+ 
+ // URL定数
+ export const ROUTES = {
+   HOME: '/',
+   DASHBOARD: '/dashboard',
+   ONBOARDING: '/onboarding',
+   PROFILE: '/profile',
+   TRENDS: '/trends',
+   SIGN_IN: '/sign-in',
+   SIGN_UP: '/sign-up',
+ } as const;
+ 
+ // API エンドポイント
+ export const API_ENDPOINTS = {
+   VIDEOS: {
+     NEWS: '/api/videos/news',
+     TRENDS: '/api/videos/trends',
+     SINGLE: '/api/videos/single',
+   },
+   TAGS: '/api/tags',
+   USER_SYNC: '/api/auth/sync',
+ } as const;
+ 
+ // エラーメッセージ
+ export const ERROR_MESSAGES = {
+   UNAUTHORIZED: 'ログインが必要です',
+   FETCH_ERROR: 'データの取得に失敗しました',
+   SAVE_ERROR: '保存に失敗しました',
+   VALIDATION_ERROR: '入力内容に誤りがあります',
+   NETWORK_ERROR: 'ネットワークエラーが発生しました',
+ } as const;
+ 
+ // 成功メッセージ
+ export const SUCCESS_MESSAGES = {
+   SAVE_SUCCESS: '正常に保存されました',
+   UPDATE_SUCCESS: '更新が完了しました',
+   DELETE_SUCCESS: '削除が完了しました',
+ } as const; 
```

---

```diff
- 
+ import { PerfType, PeriodType } from '@/types';
+ 
+ // 文字列バリデーション
+ export const validateRequired = (value: string, fieldName: string): string | null => {
+   if (!value || value.trim().length === 0) {
+     return `${fieldName}は必須です`;
+   }
+   return null;
+ };
+ 
+ export const validateMinLength = (value: string, minLength: number, fieldName: string): string | null => {
+   if (value.length < minLength) {
+     return `${fieldName}は${minLength}文字以上で入力してください`;
+   }
+   return null;
+ };
+ 
+ export const validateMaxLength = (value: string, maxLength: number, fieldName: string): string | null => {
+   if (value.length > maxLength) {
+     return `${fieldName}は${maxLength}文字以内で入力してください`;
+   }
+   return null;
+ };
+ 
+ // Email バリデーション
+ export const validateEmail = (email: string): string | null => {
+   const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
+   if (!emailRegex.test(email)) {
+     return '有効なメールアドレスを入力してください';
+   }
+   return null;
+ };
+ 
+ // URL バリデーション
+ export const validateUrl = (url: string): string | null => {
+   try {
+     new URL(url);
+     return null;
+   } catch {
+     return '有効なURLを入力してください';
+   }
+ };
+ 
+ // 型ガード
+ export const isPerfType = (value: string): value is PerfType => {
+   return value === 'genre' || value === 'keyword';
+ };
+ 
+ export const isPeriodType = (value: string): value is PeriodType => {
+   return value === 'daily' || value === 'weekly';
+ };
+ 
+ // 数値バリデーション
+ export const validatePositiveNumber = (value: number, fieldName: string): string | null => {
+   if (value <= 0) {
+     return `${fieldName}は正の数値である必要があります`;
+   }
+   return null;
+ };
+ 
+ export const validateRange = (value: number, min: number, max: number, fieldName: string): string | null => {
+   if (value < min || value > max) {
+     return `${fieldName}は${min}から${max}の間で入力してください`;
+   }
+   return null;
+ };
+ 
+ // 配列バリデーション
+ export const validateArrayLength = <T>(array: T[], min: number, max: number, fieldName: string): string | null => {
+   if (array.length < min) {
+     return `${fieldName}は最低${min}個選択してください`;
+   }
+   if (array.length > max) {
+     return `${fieldName}は最大${max}個まで選択できます`;
+   }
+   return null;
+ }; 
```

---

```diff
- 
+ import { UserSyncPayload } from '@/types';
+ 
+ // ユーザー情報の正規化
+ export const normalizeUserPayload = (clerkUser: any): UserSyncPayload => {
+   return {
+     clerkId: clerkUser.id,
+     email: clerkUser.primaryEmailAddress?.emailAddress || clerkUser.emailAddresses?.[0]?.emailAddress,
+     externalProvider: clerkUser.externalAccounts?.[0]?.provider || null,
+     externalId: clerkUser.externalAccounts?.[0]?.externalId || null,
+   };
+ };
+ 
+ // ユーザーロールのチェック
+ export const hasRole = (user: any, role: string): boolean => {
+   return user?.publicMetadata?.role === role;
+ };
+ 
+ // 管理者権限のチェック
+ export const isAdmin = (user: any): boolean => {
+   return hasRole(user, 'admin');
+ };
+ 
+ // プレミアムユーザーのチェック
+ export const isPremiumUser = (user: any): boolean => {
+   return hasRole(user, 'premium') || isAdmin(user);
+ };
+ 
+ // アクセス権限のチェック
+ export const canAccessFeature = (user: any, feature: string): boolean => {
+   switch (feature) {
+     case 'premium_videos':
+       return isPremiumUser(user);
+     case 'admin_panel':
+       return isAdmin(user);
+     default:
+       return true; // デフォルトは全ユーザーアクセス可能
+   }
+ };
+ 
+ // JWTトークンのデコード（簡易版）
+ export const decodeJWT = (token: string) => {
+   try {
+     const payload = token.split('.')[1];
+     return JSON.parse(atob(payload));
+   } catch {
+     return null;
+   }
+ };
+ 
+ // セッション有効性チェック
+ export const isSessionValid = (token: string): boolean => {
+   const decoded = decodeJWT(token);
+   if (!decoded || !decoded.exp) return false;
+   
+   return decoded.exp * 1000 > Date.now();
+ }; 
```

---

### 3. APIルートの整理

---

```bash
mkdir -p src/app/api/{auth,users}
```

```
(base) nishimuratakuakira@nishimura yuumil % 

```

---

```diff
- 
+ import { ensureUserRecord } from '@/dal/users';
+ import { normalizeUserPayload } from '@/lib/auth';
+ import { validateRequired, validateEmail } from '@/lib/validations';
+ import { ERROR_MESSAGES } from '@/lib/constants';
+ import { auth } from '@clerk/nextjs/server';
+ import { NextResponse } from 'next/server';
+ 
+ export const runtime = 'edge';
+ 
+ export async function POST(req: Request) {
+   try {
+     const { userId } = await auth();
+     if (!userId) {
+       return NextResponse.json(
+         { error: ERROR_MESSAGES.UNAUTHORIZED }, 
+         { status: 401 }
+       );
+     }
+ 
+     const body = await req.json();
+     
+     // バリデーション
+     const clerkIdError = validateRequired(body.clerkId, 'Clerk ID');
+     if (clerkIdError) {
+       return NextResponse.json(
+         { error: clerkIdError }, 
+         { status: 400 }
+       );
+     }
+ 
+     const emailError = validateEmail(body.email);
+     if (emailError) {
+       return NextResponse.json(
+         { error: emailError }, 
+         { status: 400 }
+       );
+     }
+ 
+     // ユーザー情報の正規化と保存
+     const userPayload = normalizeUserPayload(body);
+     const internalUserId = await ensureUserRecord(userPayload);
+ 
+     if (!internalUserId) {
+       return NextResponse.json(
+         { error: ERROR_MESSAGES.SAVE_ERROR }, 
+         { status: 500 }
+       );
+     }
+ 
+     return NextResponse.json({ 
+       success: true, 
+       userId: internalUserId 
+     });
+ 
+   } catch (error) {
+     console.error('User sync error:', error);
+     return NextResponse.json(
+       { error: ERROR_MESSAGES.NETWORK_ERROR }, 
+       { status: 500 }
+     );
+   }
+ } 
```

---

```diff
- 
+ import { NextResponse } from 'next/server';
+ 
+ export const runtime = 'edge';
+ 
+ export async function GET() {
+   try {
+     return NextResponse.json({
+       status: 'ok',
+       timestamp: new Date().toISOString(),
+       service: 'yuumil-api',
+       version: '1.0.0'
+     });
+   } catch (error) {
+     return NextResponse.json(
+       { 
+         status: 'error', 
+         timestamp: new Date().toISOString(),
+         error: 'Health check failed' 
+       }, 
+       { status: 500 }
+     );
+   }
+ } 
```

---

### インポートパスの修正

既存のファイルのインポートパスを新しい構造に合わせて修正します：

---

<details>
            <summary>Grep search for "from.*supabaseClient" • **6** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/nishimuratakuakira/projects/yuumil/src/dal/users.ts` | Lundefined | `import { supabase } from '@/lib/supabaseClient';` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/dal/genre.ts` | Lundefined | `import { supabase } from '@/lib/supabaseClient'` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/dal/videos.ts` | Lundefined | `import { supabase } from "@/lib/supabaseClient";` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/middleware.ts` | L1 | `import { supabase } from './lib/supabaseClient';` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/app/onboarding/page.tsx` | L1 | `import { supabase } from '@/lib/supabaseClient';` |
| `file:///Users/nishimuratakuakira/projects/yuumil/src/app/api/videos/single/route.ts` | Lundefined | `import { supabase } from "@/lib/supabaseClient";` |

</details>

---



---



---





---



---



---



---



---



---

