<!-- Generated by SpecStory -->

# Next.js コードレビューとUX向上提案 (2025-05-24 06:23:31)

_**User**_

プロジェクト全体のコードについての確認をして欲しい。
Nexr.jsのベストプラクティスについて理解した上で、どのような修正をするとよりUX体験が向上するかを教えて欲しい。
例えばクライアントコンポーネントをなるべく減らし、サーバーコンポーネントに置き換える等。
@Next.js 
@https://zenn.dev/akfm/books/nextjs-basic-principle 

---

_**Assistant**_



---

プロジェクト全体のコードを確認し、Next.jsのベストプラクティスに基づいてUX体験を向上させる修正点を提案いたします。まず、プロジェクトの構造を確認させていただきます。

---

<details>
            <summary>Listed current directory • **24** results</summary>
        
| Name |
|-------|
| 📁 `.git` |
| 📁 `docs` |
| 📄 `.gitignore` |
| 📄 `.cursorindexingignore` |
| 📁 `.specstory` |
| 📄 `env.example` |
| 📁 `src` |
| 📄 `sample.csv` |
| 📁 `.next` |
| 📁 `.cursor` |
| 📄 `package-lock.json` |
| 📁 `node_modules` |
| 📁 `supabase` |
| 📄 `package.json` |
| 📄 `next.config.ts` |
| 📁 `prisma` |
| 📁 `.vscode` |
| 📄 `next-env.d.ts` |
| 📄 `tsconfig.json` |
| 📁 `public` |
| 📄 `postcss.config.mjs` |
| 📄 `README.md` |
| 📄 `components.json` |
| 📄 `eslint.config.mjs` |

</details>

---

Next.jsプロジェクトであることが確認できました。`src`ディレクトリとその他の設定ファイルを確認してみましょう。

---

Read file: package.json

---

次に、`src`ディレクトリの構造を確認します。

---

<details>
            <summary>Listed directory src • **7** results</summary>
        
| Name |
|-------|
| 📄 `middleware.ts` |
| 📁 `components` |
| 📁 `lib` |
| 📄 `type.ts` |
| 📁 `types` |
| 📁 `dal` |
| 📁 `app` |

</details>

---

`app`ディレクトリ（App Router）の構造を確認しましょう。

---

<details>
            <summary>Listed directory src/app • **10** results</summary>
        
| Name |
|-------|
| 📄 `layout.tsx` |
| 📁 `api` |
| 📄 `page.tsx` |
| 📁 `trends` |
| 📄 `globals.css` |
| 📁 `onboarding` |
| 📁 `dashboard` |
| 📁 `(marketing)` |
| 📁 `profile` |
| 📄 `favicon.ico` |

</details>

---

`components`ディレクトリの構造も確認しましょう。

---

<details>
            <summary>Listed directory src/components • **6** results</summary>
        
| Name |
|-------|
| 📁 `common` |
| 📁 `forms` |
| 📁 `features` |
| 📁 `ui` |
| 📁 `marketing` |
| 📁 `layout` |

</details>

---

主要なファイルを確認して、現在の実装状況を理解しましょう。まず、ルートレイアウトを確認します。

---

Read file: src/app/layout.tsx

---

次に、一些主要なコンポーネントを確認します。まず、ヘッダーコンポーネントを確認しましょう。

---

Read file: src/components/layout/header.tsx

---

`ModeToggle`コンポーネントと、いくつかの主要なページも確認しましょう。

---

Read file: src/components/layout/mode-toggle.tsx

---

ダッシュボードページも確認しましょう。

---

<details>
            <summary>Listed directory src/app/dashboard • **1** results</summary>
        
| Name |
|-------|
| 📄 `page.tsx` |

</details>

---

Read file: src/app/dashboard/page.tsx

---

次に、`useVideoFeed`フックと`VideoCard`コンポーネントを確認しましょう。

---

Read file: src/lib/hooks/useVideoFeed.ts

---

Read file: src/components/features/videos/video-card.tsx

---

いくつかのAPIルートも確認しましょう。

---

<details>
            <summary>Listed directory src/app/api • **5** results</summary>
        
| Name |
|-------|
| 📁 `health` |
| 📁 `auth` |
| 📁 `users` |
| 📁 `videos` |
| 📁 `tags` |

</details>

---

Read file: src/app/api/tags/route.ts

---

`dal`（Data Access Layer）も確認しましょう。

---

<details>
            <summary>Listed directory src/dal • **3** results</summary>
        
| Name |
|-------|
| 📄 `videos.ts` |
| 📄 `genre.ts` |
| 📄 `users.ts` |

</details>

---

Next.jsの設定も確認しましょう。

---

Read file: next.config.ts

---

Read file: src/components/common/theme-provider.tsx

---

プロジェクト全体のコードを確認した結果、以下のような改善点をNext.jsのベストプラクティスに基づいて提案いたします：

## 🚀 Next.jsベストプラクティスに基づく改善提案

### 1. **Server Componentsの活用による最適化**

現在、多くのコンポーネントが不必要に`'use client'`を使用しています。以下の改善が可能です：

#### **ダッシュボードページの改善**
`src/app/dashboard/page.tsx`を Server Component に変換：

```tsx:src/app/dashboard/page.tsx
import { Suspense } from 'react';
import { auth } from '@clerk/nextjs/server';
import { listUserPreferencesByClerkId } from '@/dal/users';
import DashboardClient from '@/components/features/dashboard/dashboard-client';
import { Skeleton } from "@/components/ui/skeleton";

export default async function Page() {
  const { userId: clerkId } = await auth();
  
  if (!clerkId) {
    return <div>認証が必要です</div>;
  }

  // サーバーサイドでデータを取得
  const prefs = await listUserPreferencesByClerkId(clerkId);

  return (
    <div className="p-4 space-y-6">
      <Suspense fallback={<DashboardSkeleton />}>
        <DashboardClient initialPrefs={prefs} />
      </Suspense>
    </div>
  );
}

function DashboardSkeleton() {
  return (
    <div className="space-y-6">
      {Array.from({ length: 3 }).map((_, i) => (
        <Skeleton key={i} className="h-40 w-full" />
      ))}
    </div>
  );
}
```

#### **VideoCardコンポーネントの改善**
`VideoCard`は既にServer Componentとして正しく実装されていますが、さらに最適化可能：

```tsx:src/components/features/videos/video-card.tsx
import Image from 'next/image';
import { formatDistanceToNow } from 'date-fns';
import Link from 'next/link';
import { ja } from 'date-fns/locale';

interface Props {
  video: {
    id: string;
    youtube_id: string;
    title: string;
    thumbnail_url: string;
    published_at: string;
    total_views: number | null;
  };
}

export default function VideoCard({ video }: Props) {
  const thumb = video.thumbnail_url || '/images/no-thumb.png';

  return (
    <Link 
      href={`https://www.youtube.com/watch?v=${video.youtube_id}`}
      target="_blank"
      className="flex gap-3 border rounded-lg p-3 hover:bg-accent transition-colors"
    >
      <Image
        src={thumb}
        alt={video.title}
        width={168}
        height={94}
        className="rounded-lg shrink-0"
        priority={false}
        loading="lazy"
        sizes="(max-width: 768px) 100vw, 168px"
      />
      <div className="flex flex-col justify-between min-w-0">
        <h3 className="text-sm font-semibold line-clamp-2">{video.title}</h3>
        <div className="text-xs text-muted-foreground flex gap-2">
          <span>{(video.total_views ?? 0).toLocaleString()} 回視聴</span>
          <span>·</span>
          <span>
            {formatDistanceToNow(new Date(video.published_at), { 
              addSuffix: true, 
              locale: ja 
            })}
          </span>
        </div>
      </div>
    </Link>
  );
}
```

### 2. **Header の最適化**

現在のヘッダーを部分的に Server Component に分離：

```tsx:src/components/layout/header.tsx
import Link from 'next/link';
import { auth } from '@clerk/nextjs/server';
import HeaderClient from './header-client';
import { Suspense } from 'react';

export default async function Header() {
  const { userId } = await auth();

  return (
    <header className="fixed inset-x-0 top-0 z-50 h-16 border-b bg-background/80 backdrop-blur">
      <div className="flex h-full items-center justify-between px-4 md:px-8">
        <Link href="/" className="text-xl font-bold">ユーミル</Link>

        <nav className="hidden md:flex gap-6 text-sm font-medium">
          <Link href="/dashboard">フィード</Link>
          <Link href="/trends">トレンド</Link>
          <Link href="/profile">プロフィール</Link>
        </nav>

        <Suspense fallback={<div className="w-24 h-8 bg-muted animate-pulse rounded" />}>
          <HeaderClient isAuthenticated={!!userId} />
        </Suspense>
      </div>
    </header>
  );
}
```

```tsx:src/components/layout/header-client.tsx
'use client';

import { UserButton, SignedIn, SignedOut, SignInButton } from '@clerk/nextjs';
import { ModeToggle } from './mode-toggle';

interface HeaderClientProps {
  isAuthenticated: boolean;
}

export default function HeaderClient({ isAuthenticated }: HeaderClientProps) {
  return (
    <div className="flex items-center gap-4">
      <ModeToggle />
      
      {!isAuthenticated ? (
        <SignInButton>
          <button className="px-3 py-1 rounded bg-primary text-white">
            Sign In
          </button>
        </SignInButton>
      ) : (
        <SignedIn>
          <UserButton afterSignOutUrl="/" />
        </SignedIn>
      )}
    </div>
  );
}
```

### 3. **Loading UI とStreaming の改善**

各ページに適切な`loading.tsx`を追加：

```tsx:src/app/dashboard/loading.tsx
import { Skeleton } from "@/components/ui/skeleton";

export default function Loading() {
  return (
    <div className="p-4 space-y-6">
      {/* トグルボタンのスケルトン */}
      <div className="flex gap-3">
        {Array.from({ length: 3 }).map((_, i) => (
          <Skeleton key={i} className="h-8 w-20" />
        ))}
      </div>
      
      {/* 動画カードのスケルトン */}
      {Array.from({ length: 5 }).map((_, i) => (
        <Skeleton key={i} className="h-24 w-full" />
      ))}
    </div>
  );
}
```

### 4. **メタデータの最適化**

動的なメタデータ生成を追加：

```tsx:src/app/dashboard/page.tsx
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'ダッシュボード | ユーミル',
  description: 'あなたの興味に基づいたYouTube動画フィードを表示',
  openGraph: {
    title: 'ダッシュボード | ユーミル',
    description: 'あなたの興味に基づいたYouTube動画フィードを表示',
    type: 'website',
  },
};
```

### 5. **データフェッチングの最適化**

Request Memoization を活用したデータフェッチング：

```tsx:src/lib/data/users.ts
import { unstable_cache } from 'next/cache';
import { listUserPreferencesByClerkId as _listUserPreferencesByClerkId } from '@/dal/users';

export const getUserPreferences = unstable_cache(
  async (clerkId: string) => {
    return _listUserPreferencesByClerkId(clerkId);
  },
  ['user-preferences'],
  {
    tags: ['user-preferences'],
    revalidate: 3600, // 1時間キャッシュ
  }
);
```

### 6. **エラーハンドリングの改善**

```tsx:src/app/dashboard/error.tsx
'use client';

import { useEffect } from 'react';
import { Button } from '@/components/ui/button';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error(error);
  }, [error]);

  return (
    <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-4">
      <h2 className="text-xl font-semibold">何か問題が発生しました</h2>
      <p className="text-muted-foreground">動画の読み込み中にエラーが発生しました。</p>
      <Button onClick={reset}>再試行</Button>
    </div>
  );
}
```

### 7. **パフォーマンス最適化**

#### Bundle Analyzerの追加
```bash
npm install @next/bundle-analyzer
```

```tsx:next.config.ts
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});

const nextConfig = {
  // ... 既存の設定
};

module.exports = withBundleAnalyzer(nextConfig);
```

#### Dynamic Importsの活用
```tsx
import dynamic from 'next/dynamic';

const VideoPlayer = dynamic(() => import('@/components/features/videos/video-player'), {
  loading: () => <div className="animate-pulse bg-muted h-48 rounded" />,
  ssr: false,
});
```

### 8. **アクセシビリティの改善**

```tsx:src/components/features/videos/video-card.tsx
// WAI-ARIAの改善
<div 
  className="flex gap-3 border rounded-lg p-3 hover:bg-accent transition-colors"
  role="article"
  aria-label={`動画: ${video.title}`}
>
  <Image
    src={thumb}
    alt=""  // 装飾的な画像なので空のalt
    width={168}
    height={94}
    className="rounded-lg shrink-0"
    loading="lazy"
  />
  // ...
</div>
```

## 🎯 UX向上のための主要な改善効果

1. **初期読み込み速度の向上**: Server ComponentsによりクライアントサイドのJavaScriptバンドルサイズが削減
2. **SEOの改善**: サーバーサイドレンダリングによる検索エンジン最適化
3. **ローディング体験**: Suspenseとストリーミングによる段階的なコンテンツ表示
4. **キャッシュ効率**: Next.js 15のキャッシュ機能を最大限活用
5. **エラー処理**: 適切なエラーバウンダリによるユーザビリティ向上

これらの改善により、[Next.jsの公式ベストプラクティス](https://nextjs.org/docs/app/building-your-application/optimizing)と[Zennの記事](https://zenn.dev/akfm/books/nextjs-basic-principle)で推奨されている設計パターンに沿った、よりパフォーマンスの高いアプリケーションになります。

---

_**User**_

ありがとうございます。
実際に修正をお願いします。

---

_**Assistant**_



---

実際に修正を適用いたします。Next.jsのベストプラクティスに基づいて、段階的に改善していきます。

まず、`VideoCard`コンポーネントを改善します：

---

```diff
  import Image from 'next/image';
  import { formatDistanceToNow } from 'date-fns';
+ import { ja } from 'date-fns/locale';
+ import Link from 'next/link';
  
  interface Props {
```

```diff
  
    return (
-     <div className="flex gap-3 border rounded-lg p-3" data-video-card>
+     <Link 
+       href={`https://www.youtube.com/watch?v=${video.youtube_id}`}
+       target="_blank"
+       rel="noopener noreferrer"
+       className="flex gap-3 border rounded-lg p-3 hover:bg-accent transition-colors focus:outline-none focus:ring-2 focus:ring-primary"
+       aria-label={`動画を視聴: ${video.title}`}
+     >
        <Image
          src={thumb}
-         alt={video.title}
+         alt=""
          width={168}
          height={94}
          className="rounded-lg shrink-0"
+         priority={false}
+         loading="lazy"
+         sizes="(max-width: 768px) 100vw, 168px"
        />
        <div className="flex flex-col justify-between min-w-0">
          <h3 className="text-sm font-semibold line-clamp-2">{video.title}</h3>
          <div className="text-xs text-muted-foreground flex gap-2">
-           <span>{video.total_views ?? 0} views</span>
+           <span>{(video.total_views ?? 0).toLocaleString('ja-JP')} 回視聴</span>
            <span>·</span>
-           <span>{formatDistanceToNow(new Date(video.published_at), { addSuffix: true })}</span>
+           <span>
+             {formatDistanceToNow(new Date(video.published_at), { 
+               addSuffix: true, 
+               locale: ja 
+             })}
+           </span>
          </div>
        </div>
-     </div>
+     </Link>
    );
  }
```

---

次に、ダッシュボード用のクライアントコンポーネントを作成します：

---

```diff
- 
+ 'use client';
+ 
+ import { Skeleton } from "@/components/ui/skeleton";
+ import VideoCard from "@/components/features/videos/video-card";
+ import { useVideoFeed } from "@/lib/hooks/useVideoFeed";
+ import { Pref } from "@/types";
+ import { ToggleGroup, ToggleGroupItem } from "@radix-ui/react-toggle-group";
+ import { useEffect, useRef, useState } from "react";
+ 
+ interface DashboardClientProps {
+   initialPrefs: Pref[];
+ }
+ 
+ export default function DashboardClient({ initialPrefs }: DashboardClientProps) {
+   const [activePref, setActivePref] = useState("");
+ 
+   // 動画リスト取得
+   const { items, setSize, isLoadingMore } = useVideoFeed(activePref);
+   const sentinel = useRef<HTMLDivElement>(null);
+ 
+   // sentinelの監視（無限スクロール）
+   useEffect(() => {
+     if (!sentinel.current) return;
+     const io = new IntersectionObserver(
+       (entries) => {
+         if (entries[0].isIntersecting) {
+           setSize(prev => prev + 1);
+         }
+       },
+       { threshold: 0.1 }
+     );
+     io.observe(sentinel.current);
+     return () => io.disconnect();
+   }, [setSize]);
+ 
+   // 初回のジャンル・キーワードを自動選択
+   useEffect(() => {
+     if (initialPrefs && initialPrefs.length && !activePref) {
+       const firstPref = initialPrefs[0];
+       setActivePref(`${firstPref.type}:${firstPref.id}`);
+     }
+   }, [initialPrefs, activePref]);
+ 
+   if (!initialPrefs.length) {
+     return (
+       <div className="text-center py-12">
+         <p className="text-muted-foreground">
+           設定からジャンルやキーワードを追加してください
+         </p>
+       </div>
+     );
+   }
+ 
+   return (
+     <>
+       {/* ジャンル・キーワードのトグルボタン */}
+       <ToggleGroup 
+         type="single" 
+         value={activePref} 
+         onValueChange={setActivePref} 
+         className="flex flex-wrap gap-3"
+       >
+         {initialPrefs.map((pref) => (
+           <ToggleGroupItem 
+             key={`${pref.type}:${pref.id}`} 
+             value={`${pref.type}:${pref.id}`} 
+             className="px-4 py-2 rounded-full border data-[state=on]:bg-primary data-[state=on]:text-primary-foreground"
+             aria-label={`${pref.label}のフィードを表示`}
+           >
+             {pref.label}
+           </ToggleGroupItem>
+         ))}
+       </ToggleGroup>
+ 
+       {/* 動画リスト */}
+       <div className="space-y-4">
+         {items.length === 0 && !isLoadingMore ? (
+           <div className="text-center py-8">
+             <p className="text-muted-foreground">動画が見つかりませんでした</p>
+           </div>
+         ) : (
+           items.map((video) => (
+             <VideoCard key={video.id} video={video} />
+           ))
+         )}
+ 
+         {/* ローディングスケルトン */}
+         {isLoadingMore && (
+           <div className="space-y-4">
+             {Array.from({ length: 3 }).map((_, i) => (
+               <Skeleton key={i} className="h-24 w-full" />
+             ))}
+           </div>
+         )}
+ 
+         {/* 無限スクロール用のセンチネル */}
+         <div ref={sentinel} className="h-4" aria-hidden="true" />
+       </div>
+     </>
+   );
+ } 
```

---

次に、ダッシュボードページをサーバーコンポーネントに変換します：

---

```diff
- 'use client'
- 
+ import { Suspense } from 'react';
+ import { auth } from '@clerk/nextjs/server';
+ import { listUserPreferencesByClerkId } from '@/dal/users';
+ import DashboardClient from '@/components/features/dashboard/dashboard-client';
  import { Skeleton } from "@/components/ui/skeleton";
- import VideoCard from "@/components/features/videos/video-card";
- import { useVideoFeed } from "@/lib/hooks/useVideoFeed";
- import { Pref } from "@/types";
- import { ToggleGroup, ToggleGroupItem } from "@radix-ui/react-toggle-group";
- import { useEffect, useRef, useState } from "react";
- import useSWR from "swr";
+ import type { Metadata } from 'next';
  
- export default function Page() {
-   // ユーザーのジャンル・キーワードのリストを取得
-   const fetcher = (url: string): Promise<Pref[]> => fetch(url).then(res => res.json());
-   const { data: prefs } = useSWR<Pref[]>('api/tags', fetcher);
-   const [activePref, setActivePref] = useState("");
- 
-   // 動画リスト取得
-   const { items, setSize, isLoadingMore } = useVideoFeed(activePref);
-   const sentinel = useRef<HTMLDivElement>(null);
- 
-   // sentinelの監視 
-   useEffect(() => {
-     if (!sentinel.current) return;
-     const io = new IntersectionObserver(e => {
-       if (e[0].isIntersecting) setSize(prev => prev + 1);
-     });
-     io.observe(sentinel.current);
-     return () => io.disconnect();
-   }, [setSize]);
- 
-   // 初回のジャンル・キーワードを自動選択
-   useEffect(() => {
-     if (prefs && prefs.length && !activePref) {
-       const p = prefs[0];
-       setActivePref(`${p.type}:${p.id}`);
-     }
-   }, [prefs, activePref])
+ export const metadata: Metadata = {
+   title: 'ダッシュボード | ユーミル',
+   description: 'あなたの興味に基づいたYouTube動画フィードを表示',
+   openGraph: {
+     title: 'ダッシュボード | ユーミル',
+     description: 'あなたの興味に基づいたYouTube動画フィードを表示',
+     type: 'website',
+   },
+ };
+ 
+ function DashboardSkeleton() {
    return (
      <div className="p-4 space-y-6">
-       {/* ジャンル・キーワードのトグルボタン */}
-       {(prefs && prefs.length) && (
-         <ToggleGroup type="single" value={activePref} onValueChange={setActivePref} className="flex gap-3">
-           {prefs.map((pref) => (
-             <ToggleGroupItem key={`${pref.type}:${pref.id}`} value={`${pref.type}:${pref.id}`} className="px-4 py-1 rounded-full">
-               {pref.label}
-             </ToggleGroupItem>
-           ))}
-         </ToggleGroup>
-       )}
- 
-       {items.map((v) => (
-         
-         <VideoCard key={v.id} video={v} data-video-card />
-       ))}
- 
-       {/* Skeleton */}
-       {isLoadingMore && Array.from({ length: 3 }).map((_, i) => <Skeleton key={i} className="h-40 w-full" />)}
- 
-       <div ref={sentinel} className="h-4" />
+       {/* トグルボタンのスケルトン */}
+       <div className="flex gap-3">
+         {Array.from({ length: 3 }).map((_, i) => (
+           <Skeleton key={i} className="h-10 w-20" />
+         ))}
+       </div>
+       
+       {/* 動画カードのスケルトン */}
+       <div className="space-y-4">
+         {Array.from({ length: 5 }).map((_, i) => (
+           <Skeleton key={i} className="h-24 w-full" />
+         ))}
+       </div>
+     </div>
+   );
+ }
+ 
+ export default async function DashboardPage() {
+   const { userId: clerkId } = await auth();
+   
+   if (!clerkId) {
+     return (
+       <div className="flex items-center justify-center min-h-[50vh]">
+         <div className="text-center space-y-4">
+           <h1 className="text-2xl font-bold">認証が必要です</h1>
+           <p className="text-muted-foreground">
+             ダッシュボードにアクセスするにはログインしてください
+           </p>
+         </div>
+       </div>
+     );
+   }
+ 
+   // サーバーサイドでユーザーの設定を取得
+   const prefs = await listUserPreferencesByClerkId(clerkId);
+ 
+   return (
+     <div className="p-4 space-y-6">
+       <Suspense fallback={<DashboardSkeleton />}>
+         <DashboardClient initialPrefs={prefs} />
+       </Suspense>
      </div>
    );
```

---



---

